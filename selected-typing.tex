\begin{figure}
\small

\renewcommand*{\arraystretch}{1.25}

\definecolor{new}{HTML}{F5EFE6}

\begin{gather*}
\begin{array}{@{}r@{\hspace{2ex}}c@{\ \ }c@{\ \ }l@{}}
\text{Contexts} & \Gm, \Dl &\Coloneqq &
    \cdot \mid \Gm, A
    \\ 
\text{Substitutions} & \gm &\Coloneqq &
    \SubstWeak{n} \mid \SubstExt{\gm}{t} \mid \SubstComp{\gm_1}{\gm_2}
    \\
\text{Types} & A, B, T  &\Coloneqq &
    \cU \mid \cB \mid \bot \mid \top \mid \TyPi{A}{B} \mid \TySigma{A}{B} \mid \TyId{s}{t} \mid \TyS{t} \mid \El{t} \mid \sub{T}{\gm} \mid
    \\
    &&&
\tikzmarkin[disable rounded corners=true,set fill color=new,set border color=new]{New2}(0.05,-0.15)(-0.10,0.30)
    \TyWSingle{\wsig} \mid \wsigproj{j}{1}{\wsig} \mid \wsigproj{j}{2}{\wsig} \mid
    \TyLkg{\lsig} \mid \TyTkg{\lsig} \mid \lsigprojT{\lsig} \mid \lsigproj{2}{\lsig} \mid \CaseSig{A}{B}{T}
\tikzmarkend{New2}
    \\
\text{Terms} & t, s, \lkg &\Coloneqq &
    \var{n} \mid \sub{t}{\gm} \mid \codety{T} \mid \unit \mid \true \mid \false \mid \ifb{t_1}{t_2}{t_3} \mid \lam{t} \mid \app{t} \mid 
    \\ &&& \pair{t_1}{t_2} \mid \fst{t} \mid \snd{t} \mid \eqrefl{t} \mid  \Jeq{t_1}{t_2} \mid
    \\
    &&&
\tikzmarkin[disable rounded corners=true,set fill color=new,set border color=new]{New3}(0.05,-0.15)(-0.10,0.30)
    \wsingle{\wsig} \mid \wcode{\wsig} \mid \Wsup{\wsig}{t_1}{t_2} \mid \LkgEmp \mid \LkgAdd{\lkg}{t} \mid \inh{h}{\lkg} \mid
    \\
    &&&
    \lkgproj{1}{\lkg} \mid \lkgproj{2}{\lkg} \mid \lsigproj{s}{\lsig} \mid \Tkg{\lkg} \mid
    \Recproj{j}{\lkg} \mid \Wrec{\wsig}{\lkg}{t}
\tikzmarkend{New3}
    \\
\tikzmarkin[disable rounded corners=true,set fill color=new,set border color=new]{New1}(0.05,-0.15)(-0.10,0.30)
\text{W-type signatures} & \wsig & \Coloneqq &
    \WSigEmp \mid \WSigAdd{\wsig}{A}{B} \mid \sub{\wsig}{\gm} \mid \WSigSub{\wsig}
\tikzmarkend{New1}
    \\
\tikzmarkin[disable rounded corners=true,set fill color=new,set border color=new]{New5}(0.05,-0.15)(-0.10,0.30)
\text{Linkage signatures} & \lsig & \Coloneqq &
    \LSigEmp \mid \LSigAdd{\lsig}{\seal}{T} \mid \lsigproj{1}{\lsig} \mid \RecSig{\wsig}{T} \mid \sub{\lsig}{\gm}
\tikzmarkend{New5}
    \\
\tikzmarkin[disable rounded corners=true,set fill color=new,set border color=new]{New4}(0.05,-0.15)(-0.10,0.30)
\text{Linkage transformers} & h & \Coloneqq &
    \InhId \mid \InhExt{h}{t} \mid \InhOv{h}{t} \mid \InhInh{h} \mid \InhNest{h}{h'}
\tikzmarkend{New4}
\end{array}
\end{gather*}

\begin{mathpar}
\judgebox{\goodCtx{\Gm}{i}}

\judgebox{\goodSub{\Gm}{\gm}{\Dl}}

\judgebox{\goodType{\Gm}{T}{}}

\judgebox{\goodTerm{\Gm}{t}{T}}

\judgebox{\goodWSig{\Gm}{\wsig}{n}}

\judgebox{\goodSig{\Gm}{\lsig}{n} }

\judgebox{\goodInh{\Gm}{h}{\lsig_1}{\lsig_2}}
\\

\Rule[name=sub/id]{
    \goodCtx{\Gm}{i}
}{
    \goodSub{\Gm}{\SubstWeak{0}}{\Gm}
}

\Rule[name=sub/wk]{
    \goodSub{\Gm}{\SubstWeak{n}}{\Dl}
    \\
    \goodType{\Gm}{A}{}
}{
    \goodSub{\Gm, A}{\SubstWeak{n+1}}{\Dl}
}

\Rule[name=sub/ext]{
    \goodSub{\Gm}{\gm}{\Dl}
    \\
    \goodTerm{\Gm}{t}{\sub{A}{\gm}}
    \\
    \goodType{\Dl}{A}{}
}{
    \goodSub{\Gm}{\SubstExt{\gm}{t}}{\Dl,A}
}

\Rule[name=ty/sub]{
    \goodType{\Dl}{T}{j}
    \\
    \goodSub{\Gm}{\gm}{\Dl}
}{
    \goodType{\Gm}{T[\gm]}{j}
}

\Rule[name=tm/sub]{
    \goodTerm{\Dl}{t}{T}
    \\
    \goodSub{\Gm}{\gm}{\Dl}
}{
    \goodTerm{\Gm}{\sub{t}{\gm}}{\sub{T}{\gm}}
}

\Rule[name=tm/var]{
    \goodCtx{\Gm, A_n, ..., A_1, A_0}{}
}{
    \goodSub{\Gm, A_n, ..., A_1, A_0}{\var{n}}{\sub{A_n}{\SubstWeak{n+1}}}
}

\Rule[name=tm/lam]{
    \goodType{\Gm}{A}{}
    \\
    \goodTerm{\Gm, A}{t}{B}
}{
    \goodTerm{\Gm}{\lam{t}}{\TyPi {A} {B}}
}

\Rule[name=tm/app]{
    \goodTerm{\Gm}{t}{\TyPi {A} {B}}
}{
    \goodTerm{\Gm, A}{\app{t}}{B}
}

\Rule[name=tm/pair]{
    \goodTerm{\Gm}{t_1}{A} 
    \\
    \goodTerm{\Gm}{t_2}{\sub{B}{\SubstExt{\SubstWeak{0}}{t_1}}}
}{
    \goodTerm{\Gm}{(t_1,t_2)}{\TySigma{A}{B}}
}

\Rule[name=tm/proj]{
    \goodTerm{\Gm}{t}{\TySigma A B}
}{
    \goodTerm{\Gm}{\fst{t}}{A}
    \\
    \goodTerm{\Gm}{\snd{t}}{\sub{B}{\SubstExt{\SubstWeak{0}}{\fst{t}}}}
}

\Rule[name=ty/el]{
    \goodTerm{\Gm}{t}{\cU}
}{
    \goodType{\Gm}{\El{t}}{j}
}

\Rule[name=tm/c]{
    \goodType{\Gm}{T}{j}
}{
    \goodTerm{\Gm}{\codety{T}}{\cU}
}

\Rule[name=tm/eq/c]{
    \goodTerm{\Gm}{t}{\cU}
}{
    \goodTerm{\Gm}{\codety{\El t} \equiv t}{\cU}
}

\Rule[name=ty/eq/el]{
    \goodType{\Gm}{T}{j}
}{
    \goodType{\Gm}{\El{\codety T} \equiv T}{}
}

\Rule[name=tm/w]{
    \goodWSig{\Gm}{\wsig}{n}
}{
    \goodTerm{\Gm}{\wsingle{\wsig}}{\TyWSingle{\wsig}}
    \\
    \goodTerm{\Gm}{\wcode{\wsig}}{\cU}
}

\Rule[name=wsig/empty]{
}{
    \goodWSig{\Gm}{\WSigEmp}{0}
}

\Rule[name=wsig/add]{
    \goodWSig{\Gm}{\wsig}{n}
    \\
    \goodType{\Gm}{A}{i}
    \\
    \goodType{\Gm, A}{B}{i}
}{
    \goodWSig{\Gm}{\WSigAdd{\wsig}{A}{B}}{n+1}
}

\Rule[name=tm/wsup]{
    \goodWSig{\Gm}{\wsig}{n}
    \\
    \goodTerm{\Gm}{t_1}{\wsigproj{j}{1}{\wsig}}
    \\
    \goodTerm{\Gm, \sub{\wsigproj{j}{2}{\wsig}}{\SubstExt{\SubstWeak{0}}{t_1}}}{t_2}{\El{\wcode{\wsig}}}
    \\
    j \in \{1, ..., n\}
}{
    \goodTerm{\Gm}{\Wsup{\wsig}{t_1}{t_2}}{\El{\wcode{\wsig}}}
}

\Rule[name=tm/wrec]{
    \goodTerm{\Gm}{\lkg}{\TyLkg{\RecSig{\wsig}{T}}}
    \\
    \goodTerm{\Gm}{t}{\El{\wcode{\wsig}}}
}{
    \goodTerm{\Gm}{\Wrec{\wsig}{\lkg}{t}}{T}
}

\Rule[name=ty/casety]{
    \goodType{\Gm}{A}{}
    \\
    \goodType{\Gm, A}{B}{}
    \\
    \goodType{\Gm}{T}{}
}{
    \goodType{\Gm}{
        \CaseSig{A}{B}{R}
        \equiv
        \TyPi{A}{\TyPi {\TyPi{B}{\sub{T}{\SubstWeak{2}}}} {\sub{T}{\SubstWeak{2}}}}
    }{}
}

\Rule[name=lsig/add]{
    \goodSig{\Gm}{\lsig}{n} 
    \\
    \goodTerm{\Gm,\TyTkg{\lsig}}{\seal}{\sub{A}{\SubstWeak{1}}}
    \\
    \goodType{\Gm, A}{T}{}
}{
    \goodSig{\Gm}{\LSigAdd{\lsig}{\seal}{T}}{n+1}
}

\Rule[name=l/add]{
    \goodTerm{\Gm}{\lkg}{\TyLkg {\lsig}} 
    \\
    \goodTerm{\Gm,\TyTkg{\lsig}}{\seal}{\sub{A}{\SubstWeak{1}}}
    \\
    \goodTerm{\Gm, A}{t}{T}
}{
    \goodTerm{\Gm}{\LkgAdd{\lkg}{t}}{\TyLkg{\LSigAdd{\lsig}{\seal}{T}}}
}

\Rule[name=ty/eq/pk/empty]{
}{
    \goodType{\Gm}{\TyTkg{\LSigEmp} \equiv \top}{}
}

\Rule[name=tm/eq/pk/empty]{
}{
    \goodTerm{\Gm}{
        \Tkg{\LkgEmp}
        \equiv
        \unit
    }{\TyTkg{\LSigEmp}}
}

\Rule[name=ty/eq/pk/add]{
    \goodSig{\Gm}{\lsig}{n} 
    \\
    \goodTerm{\Gm,\TyTkg{\lsig}}{\seal}{\sub{A}{\SubstWeak{1}}}
    \\
    \goodType{\Gm, A}{T}{}
}{
    \goodType{\Gm}{
        \TyTkg {\LSigAdd  {\lsig} {\seal} {T}}
        \equiv 
        \TySigma{\TyTkg {\lsig}}{\sub{T}{\SubstExt{\SubstWeak{1}}{\seal}}}
    }{}
}

\Rule[name=tm/eq/pk/add]{
    \goodTerm{\Gm}{\lkg}{\TyLkg {\lsig}} 
    \\
    \goodTerm{\Gm,\TyTkg{\lsig}}{\seal}{\sub{A}{\SubstWeak{1}}}
    \\
    \goodTerm{\Gm, A}{t}{T}
}{
    \goodTerm{\Gm}{
        \Tkg{\LkgAdd{\lkg}{t}}
        \equiv
        \pair{\Tkg{\lkg}}{
            \sub{
                \sub{t}{\SubstExt{\SubstWeak{1}}{\seal}}
            }{\SubstExt{\SubstId}{\Tkg{\lkg}}}
        }
    }{
        \TyTkg {\LSigAdd {\lsig}{\seal}{T}}
    }
}

\end{mathpar}

\caption{Syntax and selected typing rules of \TT}
\label{fig:typing-selected}
\end{figure}