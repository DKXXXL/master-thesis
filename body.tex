\begin{abstract}
\input{abstract}
\end{abstract}

\maketitle

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{ltblue}{rgb}{0,0.4,0.4}
\definecolor{dkviolet}{rgb}{0.54,0.17,0.89}
\definecolor{dkblue}{rgb}{0.0,0.53,0.74}
\definecolor{dkred}{rgb}{0.76,0.13,0.28}


% lstlisting coq style (inspired from a file of Assia Mahboubi)
% https://tex.stackexchange.com/questions/434523/coq-syntax-highlighting
\lstdefinelanguage{Coq}{ 
    % Anything betweeen $ becomes LaTeX math mode
    mathescape=true,
    % Comments may or not include Latex commands
    texcl=false, 
    % Vernacular commands
    morekeywords=[1]{Section, Module, End, Require, Import, Export,
        Variable, Variables, Parameter, Parameters, Axiom, Hypothesis,
        Hypotheses, Notation, Local, Tactic, Reserved, Scope, Open, Close,
        Bind, Delimit, Definition, Let, Ltac, Fixpoint, CoFixpoint, Add,
        Morphism, Relation, Implicit, Arguments, Unset, Contextual,
        Strict, Prenex, Implicits, Inductive, CoInductive, Record,
        Structure, Canonical, Coercion, Context, Class, Global, Instance,
        Program, Infix, Theorem, Lemma, Corollary, Proposition, Fact,
        Remark, Example, Proof, Goal, Save, Qed, Defined, Hint, Resolve,
        Rewrite, View, Search, Show, Print, Printing, All, Eval, Check,
        Projections, inside, outside, Def,
        % For Family Poly
        Family, Extend, Field, EndFamily, SealFamily, FInductive,
        FRecursor, MetaData, EndMetaData, Closing, Final, Inherit, FTheorem
        },
    % Gallina
    morekeywords=[2]{forall, exists, exists2, fun, fix, cofix, struct,
        match, with, end, as, in, return, let, if, is, then, else, for, of,
        nosimpl, when},
    % Sorts
    morekeywords=[3]{Type, Prop, Set, true, false, option},
    % Various tactics, some are std Coq subsumed by ssr, for the manual purpose
    morekeywords=[4]{pose, set, move, case, elim, apply, clear, hnf,
        intro, intros, generalize, rename, pattern, after, destruct,
        induction, using, refine, inversion, injection, rewrite, congr,
        unlock, compute, ring, field, fourier, replace, fold, unfold,
        change, cutrewrite, simpl, have, suff, wlog, suffices, without,
        loss, nat_norm, assert, cut, trivial, revert, bool_congr, nat_congr,
        symmetry, transitivity, auto, split, left, right, autorewrite},
    % Terminators
    morekeywords=[5]{by, done, exact, reflexivity, tauto, romega, omega,
        assumption, solve, contradiction, discriminate},
    % Control
    morekeywords=[6]{do, last, first, try, idtac, repeat},
    % Comments delimiters, we do turn this off for the manual
    morecomment=[s]{(*}{*)},
    % Spaces are not displayed as a special character
    showstringspaces=false,
    % String delimiters
    morestring=[b]",
    morestring=[d],
    % Size of tabulations
    tabsize=3,
    % Enables ASCII chars 128 to 255
    extendedchars=false,
    % Case sensitivity
    sensitive=true,
    % Automatic breaking of long lines
    breaklines=false,
    % Default style fors listings
    basicstyle=\linespread{0.5}\ttfamily\footnotesize,
    % Position of captions is bottom
    captionpos=b,
    % flexible columns
    columns=[l]flexible,
    % Style for (listings') identifiers
    identifierstyle={\ttfamily\color{black}},
    % Style for declaration keywords
    keywordstyle=[1]{\ttfamily\color{dkviolet}},
    % Style for gallina keywords
    keywordstyle=[2]{\ttfamily\color{dkgreen}},
    % Style for sorts keywords
    keywordstyle=[3]{\ttfamily\color{ltblue}},
    % Style for tactics keywords
    keywordstyle=[4]{\ttfamily\color{dkblue}},
    % Style for terminators keywords
    keywordstyle=[5]{\ttfamily\color{dkred}},
    %Style for iterators
    %keywordstyle=[6]{\ttfamily\color{dkpink}},
    % Style for strings
    stringstyle=\ttfamily,
    % Style for comments
    commentstyle={\ttfamily\color{dkgreen}},
    %moredelim=**[is][\ttfamily\color{red}]{/&}{&/},
    literate=
    {\\forall}{{\color{dkgreen}{$\forall\;$}}}1
    {\\exists}{{$\exists\;$}}1
    {<-}{{$\leftarrow\;$}}1
    {=>}{{$\Rightarrow\;$}}1
    {==}{{\code{==}\;}}1
    {==>}{{\code{==>}\;}}1
    %    {:>}{{\code{:>}\;}}1
    {->}{{$\rightarrow\;$}}1
    {<->}{{$\leftrightarrow\;$}}1
    {<==}{{$\leq\;$}}1
    {\#}{{$^\star$}}1 
    {\\o}{{$\circ\;$}}1 
    {\@}{{$\cdot$}}1 
    {\/\\}{{$\wedge\;$}}1
    {\\\/}{{$\vee\;$}}1
    {++}{{\code{++}}}1
    {~}{{\ }}1
    {\@\@}{{$@$}}1
    {\\mapsto}{{$\mapsto\;$}}1
    {\\hline}{{\rule{\linewidth}{0.5pt}}}1
    %
}[keywords,comments,strings]

\section{Introduction}
\label{sec:intro}
\input{introduction.tex}

% Concept 
% Contribution

\section{Background and Challenges}
% what feature we want
% what problem/formalization we want to achieve
% Before/After Comparison of examples (with/without Fampoly)
\label{sec:background+challenge}
\input{challenge.tex}



% Macro for all use, the macro for metatheory syntax
\newcommand{\denotes}[1]{{\llbracket {#1} \rrbracket}}
\newcommand{\denotesS}[1]{{{\llbracket {#1} \rrbracket}_S}}
\newcommand{\goodCtx}[2]{{ {#1} \ \vdash }}
\newcommand{\goodType}[3]{{ {#1} \vdash {#2} }}
\newcommand{\goodTerm}[3]{{ {#1} \vdash {#2} : {#3} }}
\newcommand{\goodSub}[3]{{ {#1} \vdash {#2} : {#3} }}
\newcommand{\goodSig}[3]{{ {#1} \vdash {#2} \ \  Sig^{#3} }}
\newcommand{\goodWSig}[3]{{ {#1} \vdash {#2} \ \ WSig^{#3} }}
\newcommand{\goodSeal}[4]{{ {#1} \vdash {#2} : {#3} \  |\  {#4} }}
\newcommand{\goodInh}[4]{{ {#1} \vdash {#2} : {#3} \twoheadrightarrow {#4}}}
\newcommand{\nat}{\mathbf{N}}

\newcommand{\cU}{{\mathcal{U}}}
\newcommand{\cB}{{\mathbb{B}}}
\newcommand{\cL}{{\mathcal{L}}}
\newcommand{\cC}{{\mathcal{C}}}
\newcommand{\cCt}{{\mathcal{C}_t}}
\newcommand{\bW}{{\mathbb{W}}}

\section{Language Design}
% we need to make this section before Metatheory
% because a lot of our formulation in the metatheory
%   is inspired by the implementation
\label{sec:lang-design}
\input{lang-design.tex}

\section{Prototypical Coq Implementation}
% we need to make this section before Metatheory
% because a lot of our formulation in the metatheory
%   is inspired by the implementation
\label{sec:coqimpl}
\input{coqimpl.tex}

\section{Metatheory}

\label{sec:metatheory}
\input{metatheory.tex}




\section{Example}\label{sec:coqexample}
\input{coq-example.tex}

\section{Related Work}\label{sec:related-work}
\input{related-work.tex}

\section{Conclusion}
\label{sec:conclusion}

It is hard to write modular, extensible code and proofs.
We have presented ...

\setlength{\bibsep}{.8ex}
\bibliographystyle{tex-macros/ACM-Reference-Format.bst}
\bibliography{refs.bib}

\appendix

\section{Metatheory in (pseudo-)Agda}
We make four agda source code files (publicly and anonymously) openly avaliable, and they include the corresponding QIIT syntax definition and models. 

For syntax, please check \\ \href{https://drive.google.com/file/d/1aoG67rmXzP_x1MvZCIN3do0sucyqjwkn/view?usp=sharing}{https://drive.google.com/file/d/1aoG67rmXzP_x1MvZCIN3do0sucyqjwkn/view?usp=sharing}. This is done by mainly following the formulation \citet{altkap2016}. This is also very close to \citet{coquand2018canonicity} and \citet{sterling2019algebraic} but we formulate our syntax in a type-theoretic framework.

For syntactic translation, please check \\ \href{https://drive.google.com/file/d/1pMqn8DS4T4jiCubzk3HgMANjrfKpcGlI/view?usp=sharing}{https://drive.google.com/file/d/1pMqn8DS4T4jiCubzk3HgMANjrfKpcGlI/view?usp=sharing}. This is the first QIIT-model we give. A QIIT-model can be consider as an arbitrary mapping from the QIIT data(our syntax in this case), also respecting the quotient(judgemental equality in this case). Here we use (a subpart of) QIIT data itself as the destination of the mapping. 

For consistency model, please check \\ \href{https://drive.google.com/file/d/1pNhnn125P5byAHDaSIlpbxMvr1F-9FRo/view?usp=sharing}{https://drive.google.com/file/d/1pNhnn125P5byAHDaSIlpbxMvr1F-9FRo/view?usp=sharing}. This is following the standard model from \citet{altkap2016,kaposi2017type,kaposi2019gluing}.

For canonicity model, please check \\ \href{https://drive.google.com/file/d/1R6C7QNfyu8fbl6LE2ruvpqZ_ZDSRVo0c/view?usp=sharing}{https://drive.google.com/file/d/1R6C7QNfyu8fbl6LE2ruvpqZ_ZDSRVo0c/view?usp=sharing}. This is mainly following \citet{coquand2018canonicity,sterling2019algebraic}, but we carried out our argument in a type-theortic framework.  We call it canonicity model to emphasize that it is a model used to prove canonicity, it is also called reducibility argument, as an instance of proof-relevant logical relation. This argument can be considered as a verbose/more concrete version of \citet{kaposi2019gluing}.

We suggest using editors with proper syntax highlighting, e.g. VSCode with agda-code plugins, to read these source files.