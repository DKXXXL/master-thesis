This appendix supplements \cref{sec:metatheory2} with the details of the syntax
and the proofs of the main results.

Unlike in \cref{sec:metatheory2}, which uses named binders, in this appendix we
use \citeauthor{debruijn1964} indices and \emph{explicit
substitutions}~\cite{abadi1989subst,substcalculus}:
substitutions~$\gm$ and their applications (e.g., \sub{T}{\gm}, which
applies~$\gm$ to the type~$T$) are part of the syntax rather than
meta-operations. 
We work in an intrinsically typed setting: terms are well typed by construction.
This style of syntax formulation follows a recent
trend~\cite{altkap2016,coquand2018canonicity,gratzer-sterling-birkedal-2019}
known as the ``algebraic presentation'' of MLTT.
%We introduce judgmental equality ($\equiv$)
%for derivations (of all kinds of judgements). In other words, we will have judgemental equality between terms, 
%contexts, explicits substitutions, and etc. 
%This style of syntax formulation has been carried out by the recent trend~\cite{altkap2016,coquand2018canonicity,gratzer-sterling-birkedal-2019} dubbed as ``algebraic presentation'' of MLTT. 
Moreover, universe levels are explicit in this appendix.

Other aspects of the syntax remain the same as in \cref{sec:metatheory2}.
In particular,
%following \citet{altkap2016,coquand2018canonicity,gratzer-sterling-birkedal-2019},
the syntax is still considered as being quotiented by the judgmental equalities.
Quotienting facilitates coercion along equalities.
Furthermore, the semantic model we develop in this appendix respects these
judgmental equalities by construction.
%This means 
%(1) our model have to respect the judgemental equalities to be a legitimate model for the quotiented syntax, and (2) we have convertibility for free---when we have definitionally equal $A \equiv B$, thanks to the quotient syntax, the derivation of $t : A$ is the same as the derivation of $t : B$.

%After the syntax, we detail the models and proofs for syntactic translation (that translate away linkages),  consistency and canonicity. 



\subsection{Review MLTT in Debruijn Indices, Explicit Subst, and Explicit Universe Level}

\TT can be roughly considered as MLTT with linkages so we still start with vanilla MLTT first.


\input{all-mltt-typing}

\noindentparagraph{Debruijn Indices and Explicit Substitution.}  The change of the syntax formulation is important to the simplicity of our proof, as we want to handle the proof about substitutions and terms uniformly---thus making substitution as part of the syntax (explicit substitution) will be helpful. 

Variables are in the form of \citeauthor{debruijn1964} indices:
\var{n} is the variable bound by the $n$-th closest enclosing binder.
For example, $\lambda x.\,\lambda y.\,x$ is $\lam{\lam{\var{1}}}$.
%
Substitutions are typed with the form 
$\goodSub{\Gm}{\gm}{\Dl}$.
The idea is that applying~$\gm$ to terms valid in the context~$\Dl$
yields terms valid in~$\Gm$ (\ruleref{tm/sub} and \ruleref{ty/sub}).
%
The two main forms of substitutions are weakening (\ruleref{sub/wk}) and extension (\ruleref{sub/ext}):
\sub{t}{\SubstWeak{n}} introduces $n$ free variables into the context of $t$, and
\sub{t}{\SubstExt{\gm}{t'}} substitutes~$t'$ for~$\var{0}$ in~$t$ and
then applies~$\gm$.
For example, rule \ruleref{tm/snd} states that if $t$ is a dependent pair
that has type $\TySigma{A}{B}$, then $\snd{t}$ has type
$\sub{B}{\SubstExt{\SubstWeak{0}}{\fst{t}}}$,
where $\SubstId$ is the identity substitution (\ruleref{sub/id}).

To simplify, $\SubstWeak{n}$ is a short hand for $\pi_1^n~"id"$ and $\var{n}$ is a short hand for $\pi_2~\pi_1^{n}$. Thus during meta-theoretic reasoning, we will only deal with $\pi_1$ and $\pi_2$.

Finally, we have \ruleref{sub/dbj/shift} defined using \ruleref{sub/wk} and \ruleref{tm/var}. This rule applying substitution $\gm$ on the earlier part of the context. We usually omit $A$ in the $\gm^{\uparrow A}$ because it can be inferred from the context.



\noindentparagraph{Explicit Universe Level.} Our treatment of universe level mainly follows that of \citet{altkap2016, kaposi2019gluing}. Universe level is mainly to get around the size issue---we cannot refer to (and thus quantifiy over) a set of all set (or a universe of all type)~\cite{hurkens1995simplification}. So everytime we want to quantify over a universe of types, we have to specify ``how large'' that universe is, that is basically what universe level is measuring. 



Now we will need to attach some syntax pieces with natural number indicating universe levels. The explicit universe level $i$ now will attach to each context and type judgement $\goodCtx{\Gm}{i}$ and $\goodType{\Gm}{T}{i}$ basically indicating the context $\Gm$ and $T$ inhabits at what universe. Apparently, universe level will also be attached to $\cU$. For two universe level $i,j$ (as natural number), we use $i \lcup j$ to denotes $\max(i,j)$.

Since we work in an intrinsic-typed setting, some required premises can be omitted without ambiguity. For omitted context judgement $\goodCtx{\Gm}{k}$, the universe level is always $k$, hinted at the figure of judgement specification. Similar for type judgement $\goodType{\Gm}{T}{j}$.



% Copy and Paste Intuition of MLTT from other places to here
\subsection{Declarative Syntax for \TT : an MLTT variant with Linkages}
Compared to MLTT, \TT has 3 more judgements about signatures and linkage transformers. Moreover, the linkage transformer can be considered as a syntactic sugar (or ``library functions'' in the main text) (we will show why at the end). 
Since it is a syntactic sugar, we will not consider about the linkage transformers during meta-theoretic reasoning.


\input{all-fmltt-typing}

% Copy and Paste Intuition of FMLTT from other places to here


% Deal with intuition



\subsection{Syntactic Translation to get rid of Linkages}

\input{syn-translate.tex}

% \subsection{Standard Model for Consistency}

% \input{standardmodel.tex}


\subsection{Proof Relevant Logical Relation for Canonicity}
\input{canonicitymodel.tex}

\subsection{Linkage Transformer as Syntax Sugar}
Observe the syntax, linkage transformer and its judgement is defined above 
other parts. 

So we can inductively define the syntax sugar $\goodInh{\Gm}{h}{\lsig_1}{\lsig_2}$ using constructors $\InhExt{}{}$, $\InhOv{}{}$, $\InhInh{}$, $\InhNest{}{}$. Then we define the $\inh{h}{\ell}$ and the explicit substitution for linkage transformer $\sub{h}{\gm}$ by induction on the structure of linkage transformer $h$, based on the equality
%\EDJ{Add substitution equalities for linkage transformers} 
given in the syntax. In that way, the explicit substituon for linkage transformer becomes meta-level substitution again; and $\inh{h}{\ell}$ is not itself a syntax but a meta-level computation that leads to a syntax.