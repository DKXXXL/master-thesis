This appendix supplements \cref{sec:metatheory2} with the details of the syntax
and the proofs of the main results.

Unlike in \cref{sec:metatheory2}, which uses named binders, in this appendix we
use \citeauthor{debruijn1964} indices and \emph{explicit
substitutions}~\cite{abadi1989subst,substcalculus}:
substitutions~$\gm$ and their applications (e.g., \sub{T}{\gm}, which
applies~$\gm$ to the type~$T$) are part of the syntax rather than
meta-operations. 
We work in an intrinsically typed setting: terms are well typed by construction.
This style of syntax formulation follows a recent
trend~\cite{altkap2016,coquand2018canonicity,gratzer-sterling-birkedal-2019}
known as the ``algebraic presentation'' of MLTT.
%We introduce judgmental equality ($\equiv$)
%for derivations (of all kinds of judgements). In other words, we will have judgemental equality between terms, 
%contexts, explicits substitutions, and etc. 
%This style of syntax formulation has been carried out by the recent trend~\cite{altkap2016,coquand2018canonicity,gratzer-sterling-birkedal-2019} dubbed as ``algebraic presentation'' of MLTT. 
Moreover, universe levels are explicit in this appendix.

Other aspects of the syntax remain the same as in \cref{sec:metatheory2}.
In particular,
%following \citet{altkap2016,coquand2018canonicity,gratzer-sterling-birkedal-2019},
the syntax is still considered as being quotiented by the judgmental equalities.
Quotienting facilitates coercion along equalities.
Furthermore, the semantic model we develop in this appendix respects these
judgmental equalities by construction.
%This means 
%(1) our model have to respect the judgemental equalities to be a legitimate model for the quotiented syntax, and (2) we have convertibility for free---when we have definitionally equal $A \equiv B$, thanks to the quotient syntax, the derivation of $t : A$ is the same as the derivation of $t : B$.

%After the syntax, we detail the models and proofs for syntactic translation (that translate away linkages),  consistency and canonicity. 


\subsection{MLTT with Explicit Substitutions and Universe Levels}
\label{sec:mltt-full}

We review the base MLTT fragment of \TT first.
\input{all-mltt-typing}

\noindentparagraph{De Bruijn Indices and Explicit Substitution.}

\Citeauthor{debruijn1964} indices and explicit substitutions make details about
binders and substitutions explicit.
%The change of the syntax formulation is important to the simplicity of our
%proof, as we want to handle the proof about substitutions and terms
%uniformly---thus making substitution as part of the syntax (explicit
%substitution) will be helpful. 

The form \var{n} represents a variable bound by the $n$-th closest enclosing binder.
For example, $\lambda x.\,\lambda y.\,x$ is $\lam{\lam{\var{1}}}$.
%
Substitutions are typed with the form 
$\goodSub{\Gm}{\gm}{\Dl}$.
The idea is that applying~$\gm$ to terms valid in the context~$\Dl$
yields terms valid in~$\Gm$ (\ruleref{tm/sub} and \ruleref{ty/sub}).
%
The two main forms of substitutions are weakening (\ruleref{sub/wk}) and extension (\ruleref{sub/ext}):
\sub{t}{\SubstWeak{n}} introduces $n$ free variables into the context of $t$, and
\sub{t}{\SubstExt{\gm}{t'}} substitutes~$t'$ for~$\var{0}$ in~$t$ and
then applies~$\gm$.
For example, rule \ruleref{tm/snd} states that if $t$ is a dependent pair
that has type $\TySigma{A}{B}$, then $\snd{t}$ has type
$\sub{B}{\SubstExt{\SubstWeak{0}}{\fst{t}}}$,
where $\SubstId$ is the identity substitution (\ruleref{sub/id}).

To simplify, $\SubstWeak{n}$ is a short hand for $\pi_1^n~"id"$ and $\var{n}$ is a short hand for $\pi_2~\pi_1^{n}$. Thus during meta-theoretic reasoning, we will only deal with $\pi_1$ and $\pi_2$.\YZ{$\pi_1$ and $\pi_2$ should be added to the syntax figure}\EDJreply{I added it, it is right after sub/dbj/shift.}

Finally, we have \ruleref{sub/dbj/shift} defined using \ruleref{sub/wk} and \ruleref{tm/var}. This rule applying substitution $\gm$ on the earlier part of the context. We usually omit $A$ in the $\gm^{\uparrow A}$ because it can be inferred from the context.\YZ{The shift rule has bugs: premise says n, conclusion says 1.}\EDJreply{Thanks, fixed.}



\noindentparagraph{Universe levels.}

Universe levels address the size issue---it is unsound to have a set of all sets
(or a universe of all types).
The level of a universe specifies ``how large'' that universe is.
%that is basically what universe level is measuring. 

%The treatment of universe levels follows \citet{altkap2016, kaposi2019gluing}.
The judgment form $\goodType{\Gm}{T}{i}$ indicates that (the code of) the type $T$
inhabits universe~$\cU_i$.
Similarly, $\goodCtx{\Gm}{i}$ indicates that (the codes of) the types in $\Gm$
inhabit universe~$\cU_i$.
The notation $i \lcup j$ denotes $\max(i,j)$.

%Since we work in an intrinsic-typed setting, some required premises can be omitted without ambiguity. For omitted context judgement $\goodCtx{\Gm}{k}$, the universe level is always $k$, hinted at the figure of judgement specification. Similar for type judgement $\goodType{\Gm}{T}{j}$.



% Copy and Paste Intuition of MLTT from other places to here
\subsection{\TT}
\label{sec:fmltt-full}

\TT extends the MLTT in \cref{sec:mltt-full} with W-type signatures and W-types,
linkage signatures and linkages, and linkage transformers.

\input{all-fmltt-typing}

% Copy and Paste Intuition of FMLTT from other places to here


% Deal with intuition

\noindentparagraph{Linkage transformers as syntactic sugar.}


%Observe the syntax, linkage transformer and its judgement is defined above 
%other parts. 
%
%So we can inductively define the syntax sugar $\goodInh{\Gm}{h}{\lsig_1}{\lsig_2}$ using constructors $\InhExt{}{}$, $\InhOv{}{}$, $\InhInh{}$, $\InhNest{}{}$. Then we define the $\inh{h}{\ell}$ and the explicit substitution for linkage transformer $\sub{h}{\gm}$ by induction on the structure of linkage transformer $h$, based on the equality
%%\EDJ{Add substitution equalities for linkage transformers} 
%given in the syntax. In that way, the explicit substituon for linkage transformer becomes meta-level substitution again; and $\inh{h}{\ell}$ is not itself a syntax but a meta-level computation that leads to a syntax.

As mentioned in \cref{sec:metatheory2}, the five forms of linkage transformers can be
thought of a library of functions that are used to construct linkages from other
linkages.
In particular, their typing rules are defined in terms of the rest of the typing
rules in \TT.
Thus, linkage transformers $\goodInh{\Gm}{h}{\lsig_1}{\lsig_2}$ can be defined
as syntactic sugar via an inductive type (in the meta\-logic) with four constructors
%\YZ{I reinterpreted what you wrote, but this sentence doesn't sound right to me. If linkage transformers are meta-level inductive types, aren't they just part of the syntax?}\EDJreply{I think the reason that they are syntactic sugar is because they can be interpreted using FMLTT syntax(without them), it is fine either the syntactic sugar is defined via inductive type (and then interpreted), or directly interpreted. Maybe I should remove this misleading sentence? \\ What's more, the specification/definition of syntactic sugar itself, is inductive type. Because a linkage transformer looks inductive. Maybe I should directly separate the typing rules for linkage transformer as another figure to emphasize it as an inductive construction on the rest FMLTT syntax?}
$\InhExt{}{}$, $\InhOv{}{}$, $\InhInh{}$, and $\InhNest{}{}$.
Moreover, $\inh{h}{\ell}$ and $\sub{h}{\gm}$ can be defined
as recursive functions (in the meta\-logic) by induction on this inductive type.
We will treat linkage transformers as syntactic sugar in the meta\-theoretic development
in the rest of \cref{sec:complete-fmltt}.

\subsection{A Translation that Compiles Away Linkages}


\input{syn-translate.tex}

% \subsection{Standard Model for Consistency}

% \input{standardmodel.tex}


\subsection{A Proof Relevant Logical-Relations Model for Canonicity}
\input{canonicitymodel.tex}

